<!DOCTYPE html>
<html lang="ja">
	<!DOCTYPE html>
	<html lang="ja">
<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>fuh</title>
	<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
	<meta name="theme-color" content="#ff8c00">
  <link rel="stylesheet" href="style.css" />
	<link rel="manifest" href="manifest.json" />
	<link rel="icon" href="assets/icon-192.png" />

			<style>
				body {
					font-family: 'Segoe UI', sans-serif;
					margin: 0;
					padding: 0;
					overflow-x: hidden; /* â† æ¨ªã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«é˜²æ­¢ã«ã‚ƒï¼ */
				}
			</style>
			<!-- ãƒ˜ãƒƒãƒ€ãƒ¼ã«DMãƒœã‚¿ãƒ³ã‚’è¿½åŠ  -->
		<button onclick="toggleDmList()">ğŸ“© DM</button>
		<script type="module">
			// Firebase SDK v9ï¼ˆãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«æ–¹å¼ï¼‰
			import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
			import { getFirestore, collection, addDoc, getDocs, serverTimestamp, query, orderBy } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";

			// Your web app's Firebase configuration
			const firebaseConfig = {
				apiKey: "AIzaSyDZ7_knmmooX5aTOPi0oDtg9YK7vMsRRUM",
				authDomain: "i-post-02-fuh.firebaseapp.com",
				projectId: "i-post-02-fuh",
				storageBucket: "i-post-02-fuh.firebasestorage.app",
				messagingSenderId: "697591520408",
				appId: "1:697591520408:web:2155ea15b02bd1fd6cc4ed"
			};


			const app = initializeApp(firebaseConfig);
			window.db = getFirestore(app); // ã‚°ãƒ­ãƒ¼ãƒãƒ«ã§ä½¿ãˆã‚‹ã‚ˆã†ã«
		</script>

</head>

<body onclick="closeAllMenus(event)">
  <!-- ğŸ”½ ç”»é¢1: æŠ•ç¨¿ç”»é¢ï¼ˆHomeï¼‰ -->

	<div id="header">
		
		<!-- ãƒãƒ³ãƒãƒ¼ã‚¬ãƒ¼ãƒ¡ãƒ‹ãƒ¥ãƒ¼ -->
		<button class="hamburger" onclick="toggleMenu()">â˜°</button>
		<h1 class="title">fuh</h1>
	</div>

	<div id="mainScreen">	
	
  <!-- mainè¡¨ç¤ºé ˜åŸŸ -->
  <div class="container">


	  <!-- ğŸ” æŠ•ç¨¿æ¤œç´¢ãƒœãƒƒã‚¯ã‚¹ -->
		<div style="display: flex; gap: 10px; align-items: center; flex-wrap: wrap;">
			<div class="search-box">
				<input type="text" id="searchInput" placeholder="Search" oninput="filterMessages()" />
				<button type="button" class="search-btn"></button>
			</div>

		<!-- ä¸Šä¸‹ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ãƒœã‚¿ãƒ³ -->
		<div id="scrollButtons">
			<button class="scroll-btn" onclick="scrollToTop()">â†‘</button>
			<button class="scroll-btn" onclick="scrollToBottom()">â†“</button>
		</div>

		<!-- ğŸ”½ Searchã®ã™ãä¸‹ã«é…ç½® -->
		<div class="timeline-tabs">
			<button class="tab-btn active" onclick="switchTimeline('tab1')">1</button>
			<button class="tab-btn" onclick="switchTimeline('tab2')">2</button>
			<button class="tab-btn" onclick="switchTimeline('tab3')">3</button>
			<button class="tab-btn" onclick="switchTimeline('tab4')">4</button>
		</div>
		

		<!-- ä»¥ä¸‹ã€Postãƒœã‚¿ãƒ³ã‚„æŠ•ç¨¿ãƒ•ã‚©ãƒ¼ãƒ ã€æŠ•ç¨¿ãƒªã‚¹ãƒˆ -->
    <button id="toggleFormBtn" onclick="togglePostForm()">post</button>

		<div id="postFormWrapper" class="post-form-wrapper">
			<button class="cancel-btn" onclick="togglePostForm()">Ã—</button>
		
			<div class="post-form-row">
				<textarea id="messageInput" placeholder="your message..." oninput="autoGrow(this); updateCharacterCount()" rows="1"></textarea>

				<button class="post-btn" onclick="postLocalMessage()">Post</button>
			</div>
		
			<div id="charCount" style="text-align: right; font-size: 0.8em; margin-top: 4px; color: #0a1d4d;">0 / 300</div>
		</div>
		

		


    <ul id="messageList" class="message-list"></ul>
  </div>

		</div>
	</div>

  <!-- ğŸ”½ ç”»é¢2: è¨­å®šç”»é¢ï¼ˆSettinï¼‰ -->
	<div id="settingScreen" class="slide-panel">
    <div class="container">
			
  <!-- ğŸ”½ è¡¨ç¤ºåˆ‡æ›¿ãƒœã‚¿ãƒ³ã¯ã“ã“ã«é…ç½®ã™ã‚‹ã«ã‚ƒï¼ -->
  <button class="toggle-mode" onclick="toggleViewMode()">change</button>
      <h2>ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«è¨­å®š</h2>
	  <!--  ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã‚¢ã‚¤ã‚³ãƒ³ -->		
		<div style="display: flex; align-items: center; gap: 10px;">
			<div id="profileIconBox" onclick="toggleIconSelector()" style="cursor: pointer;">
				<img id="profileIcon" src="icons/p-icon-01.png" style="width: 40px; height: 40px; border-radius: 50%;" />
			</div>
	  <!--  åå‰ãƒœãƒƒã‚¯ã‚¹ -->		
			<div class="displayname-box">
				<input type="text" id="displayNameInput" placeholder="your name" maxlength="30" oninput="setDisplayName(this.value)" />

			</div>
		</div>
				<!-- ğŸ”½ ã‚¢ã‚¤ã‚³ãƒ³é¸æŠUIï¼ˆæœ€åˆã¯éè¡¨ç¤ºï¼‰ -->
				<div id="iconSelector" style="display: none; margin-top: 8px;">
					<div style="display: flex; flex-wrap: wrap; gap: 6px;">
						<img src="icons/p-icon-01.png" onclick="selectIcon('icons/p-icon-01.png')" style="width: 40px; height: 40px; border-radius: 50%; cursor: pointer;" />
						<img src="icons/p-icon-02.png" onclick="selectIcon('icons/p-icon-02.png')" style="width: 40px; height: 40px; border-radius: 50%; cursor: pointer;" />
						<img src="icons/p-icon-03.png" onclick="selectIcon('icons/p-icon-03.png')" style="width: 40px; height: 40px; border-radius: 50%; cursor: pointer;" />
						<img src="icons/p-icon-04.png" onclick="selectIcon('icons/p-icon-04.png')" style="width: 40px; height: 40px; border-radius: 50%; cursor: pointer;" />
						<img src="icons/p-icon-05.png" onclick="selectIcon('icons/p-icon-05.png')" style="width: 40px; height: 40px; border-radius: 50%; cursor: pointer;" />
						<img src="icons/p-icon-06.png" onclick="selectIcon('icons/p-icon-06.png')" style="width: 40px; height: 40px; border-radius: 50%; cursor: pointer;" />
						<img src="icons/p-icon-07.png" onclick="selectIcon('icons/p-icon-07.png')" style="width: 40px; height: 40px; border-radius: 50%; cursor: pointer;" />
						<img src="icons/p-icon-08.png" onclick="selectIcon('icons/p-icon-08.png')" style="width: 40px; height: 40px; border-radius: 50%; cursor: pointer;" />
						<img src="icons/p-icon-09.png" onclick="selectIcon('icons/p-icon-09.png')" style="width: 40px; height: 40px; border-radius: 50%; cursor: pointer;" />
						<img src="icons/p-icon-10.png" onclick="selectIcon('icons/p-icon-10.png')" style="width: 40px; height: 40px; border-radius: 50%; cursor: pointer;" />
						<img src="icons/p-icon-11.png" onclick="selectIcon('icons/p-icon-11.png')" style="width: 40px; height: 40px; border-radius: 50%; cursor: pointer;" />  </div>
				</div>
    </div>
  </div>

	<!-- æ€§åˆ¥é¸æŠæ¬„ -->
	<div class="gender-box">
		<label for="genderSelect">æ€§åˆ¥:</label>
		<select id="genderSelect" onchange="saveGender()">
			<option value="male">ç”·</option>
			<option value="female">å¥³</option>
			<option value="unspecified">æœªè¨­å®š</option>
		</select>
	</div>

	<!-- èª¬æ˜æ–‡å…¥åŠ›ã‚¨ãƒªã‚¢ -->
	<div class="description-box">
		<label for="descriptionInput">è‡ªå·±ç´¹ä»‹:</label>
		<textarea id="descriptionInput" placeholder="è‡ªå·±ç´¹ä»‹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„..." rows="4" oninput="updateDescription()"></textarea>
	</div>

	<!-- ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã‚¢ã‚¤ã‚³ãƒ³ -->
	<div id="profileIconBox" onclick="toggleIconSelector()" style="cursor: pointer;">
		<a href="profile.html">
			<img id="profileIcon" src="p-icon-01.png" style="width: 40px; height: 40px; border-radius: 50%;" />
		</a>
	</div>

  <!-- ğŸ”½ ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ãƒãƒ¼ï¼ˆå¸¯ï¼‰
	<div class="bottom-nav">
	</div>
		 -->

  <script>
  if ('serviceWorker' in navigator) {
    window.addEventListener('load', () => {
      navigator.serviceWorker.register('/service-worker.js').then(registration => {
        console.log('ServiceWorkerç™»éŒ²æˆåŠŸ:', registration.scope);
      }).catch(error => {
        console.log('ServiceWorkerç™»éŒ²å¤±æ•—:', error);
      });
    });
  }

let savedScrollY = 0;

function switchView(view) {
  const main = document.getElementById("mainScreen");
  const setting = document.getElementById("settingScreen");

  if (view === 'setting') {
    // ğŸ“Œ Homeã®ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ä½ç½®ã‚’è¨˜éŒ²ã—ã¦ã‹ã‚‰éè¡¨ç¤º
    savedScrollY = window.scrollY;
    main.style.display = "none";
    setting.style.display = "block";
  } else if (view === 'main') {
    main.style.display = "block";
    setting.style.display = "none";

    // ğŸ“Œ å‰å›ã®ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ä½ç½®ã¸æˆ»ã™
    window.scrollTo(0, savedScrollY);
  }
}



function togglePostForm() {
  const form = document.getElementById("postFormWrapper");
  const button = document.getElementById("toggleFormBtn");
  form.classList.toggle("show");
  button.classList.toggle("hide");

  if (form.classList.contains("show")) {
    document.getElementById("messageInput").focus();
    updateCharacterCount(); // â†ã“ã‚Œã‚’è¿½åŠ ï¼
  }
}



function formatRelativeTime(timestamp) {
  return `${timestamp.getFullYear()}/${timestamp.getMonth() + 1}/${timestamp.getDate()} ${timestamp.getHours()}:${String(timestamp.getMinutes()).padStart(2, '0')}`;
}

    //* ãƒ»ãƒ»ãƒ»ãƒœã‚¿ãƒ³ã®è¡¨ç¤ºåˆ‡æ›¿ *//
    function toggleMenu(id) {
      document.querySelectorAll('.menu-options').forEach(el => el.classList.remove('show'));
      const menu = document.getElementById(`menu-${id}`);
      if (menu) menu.classList.toggle("show");
    }
				async function deletePostFromFirestore(docId, liElement) {
						const { doc, deleteDoc } = await import("https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js");
						if (!window.db || !docId) return;

						const confirmDelete = confirm("ã“ã®æŠ•ç¨¿ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ");
						if (!confirmDelete) return;

						try {
							await deleteDoc(doc(window.db, "posts", docId));
							liElement.remove(); // DOMã‹ã‚‰ã‚‚å‰Šé™¤
							console.log("ğŸ—‘ æŠ•ç¨¿ã‚’Firestoreã‹ã‚‰å‰Šé™¤ã—ã¾ã—ãŸï¼š", docId);
						} catch (e) {
							console.error("å‰Šé™¤å¤±æ•—ï¼š", e);
						}
					}


    function closeAllMenus(event) {
      if (!event.target.closest('.menu-toggle')) {
        document.querySelectorAll('.menu-options').forEach(el => el.classList.remove('show'));
      }
    }

		function scrollToTop() {
			window.scrollTo({ top: 0, behavior: 'smooth' });
		}

		function scrollToBottom() {
			window.scrollTo({ top: document.body.scrollHeight, behavior: 'smooth' });
		}


    let messageCount = 0;
		function postLocalMessage() {
				const input = document.getElementById("messageInput");
				const text = input.value.trim();
				const type = currentTimeline;

				if (text === "") {
					alert("æŠ•ç¨¿æ–‡ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚");
					return;
				}

				if (text.length > 300) {
					alert("æ–‡å­—æ•°ã¯300æ–‡å­—ä»¥å†…ã«ã—ã¦ãã ã•ã„ã€‚");
					return;
				}

				const linkCount = (text.match(/https?:\/\/[^\s]+/g) || []).length;
				if (linkCount > 1) {
					alert("2ã¤ä»¥ä¸Šã®ãƒªãƒ³ã‚¯ã¯è²¼ã‚Œã¾ã›ã‚“ã€‚");
					return;
				}

				const convertedText = autoLink(text).replace(/\n/g, "<br>");
				const li = document.createElement("li");
				li.dataset.timeline = type;

				const now = new Date();
				const user = document.getElementById("displayNameInput")?.value.trim() || "åŒ¿å";
				const key = `msg-${messageCount++}`;
				const savedName = localStorage.getItem("displayName") || "";
				const isOwn = user === savedName;
				li.className = "message " + (isOwn ? "own" : "other");

  li.innerHTML = `
    <div class="message-header">
			<span class="message-user">
				<img src="${document.getElementById("profileIcon").src}" class="user-icon" />
				${user}
			</span>
			<div style="margin-left: auto; display: flex; align-items: center; gap: 8px;">
				${renderReplyAndLikeCount(key)}
				<div style="position: relative;">
					<button class="menu-toggle" onclick="toggleMenu('${key}')"></button>
					<div class="menu-options" id="menu-${key}">
						<button><img src="icons/icon-delete.png" style="width: 16px; height: 16px;" /> å‰Šé™¤</button>
					</div>
				</div>
				<span class="message-time">${formatRelativeTime(now)}</span>
			</div>
		</div>

    <div class="message-text" data-original="${text}">${convertedText}</div>

    </div>
    <div class="reply-box" id="replyBox-${key}" style="display: none;">
      <div class="reply-list" id="replies-${key}"></div>
      <textarea
        class="reply-input"
        id="replyInput-${key}"
        rows="1"
        placeholder="your messageâ€¦"
        oninput="updateReplyCharCount('${key}')"
        style="resize: none;"
      ></textarea>
      <div class="reply-meta">
        <span class="reply-char-count" id="replyCharCount-${key}">0 / 300</span>
        <button class="reply-send-btn" onclick="submitReply('${key}')">reply</button>
      </div>
    </div>
  `;

  document.getElementById("messageList").prepend(li);
  input.value = "";
  input.rows = 1;
  input.style.height = "auto";
  updateCharacterCount();
  togglePostForm();
  li.scrollIntoView({ behavior: "smooth", block: "start" });
	import("https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js").then(({ collection, addDoc, serverTimestamp }) => {
      const postData = {
        user: user,
        text: text,
        icon: document.getElementById("profileIcon").src,
        time: serverTimestamp(),
        timeline: type
      };

			addDoc(collection(window.db, "posts"), postData)
			.then(docRef => {
				console.log("ğŸ“¦ Firestore ã«æŠ•ç¨¿ã‚’ä¿å­˜ã—ã¾ã—ãŸï¼š", docRef.id);
				li.dataset.docId = docRef.id; // â† æŠ•ç¨¿DOMã«Firestoreã®IDã‚’ä¿å­˜
			})
			.catch(error => {
				console.error("ğŸ”¥ Firestore ä¿å­˜ã‚¨ãƒ©ãƒ¼:", error);
			});

    });
  }
		
	  function toggleViewMode() {
    document.body.classList.toggle("old-style");
  	}

		function toggleView(view) {
			const main = document.getElementById("mainScreen");
			const setting = document.getElementById("settingScreen");

			if (view === 'setting') {
				main.style.display = "none";  // Mainç”»é¢ã‚’éè¡¨ç¤º
				setting.style.display = "block";  // Settingç”»é¢ã‚’è¡¨ç¤º
			} else if (view === 'main') {
				main.style.display = "block";  // Mainç”»é¢ã‚’è¡¨ç¤º
				setting.style.display = "none";  // Settingç”»é¢ã‚’éè¡¨ç¤º
			}
		}

		function updateReplyCharCount(key) {
			const input = document.getElementById(`replyInput-${key}`);
			const count = input.value.length;
			const countDisplay = document.getElementById(`replyCharCount-${key}`);
			countDisplay.textContent = `${count} / 300`;
			countDisplay.style.color = count > 300 ? "red" : "#0a1d4d";
		}

		async function submitReply(postId) {
  const input = document.getElementById(`replyInput-${postId}`);
  const text = input.value.trim();

  if (!text) return;
  if (text.length > 1000) {
    alert("è¿”ä¿¡ã¯1000æ–‡å­—ä»¥å†…ã§ã™");
    return;
  }

  const user = document.getElementById("displayNameInput")?.value.trim() || "åŒ¿å";
  const time = serverTimestamp(); // Firestoreã®ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—ã‚’ä½¿ç”¨

  // Firestoreã®è¿”ä¿¡ãƒ‡ãƒ¼ã‚¿ä¿å­˜
  if (!window.db) return;

  const { collection, addDoc } = await import("https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js");

  try {
    const replyData = {
      user: user,
      text: text,
      time: time,
      postId: postId,  // è¿”ä¿¡å…ƒã®æŠ•ç¨¿ID
    };

    await addDoc(collection(window.db, "replies"), replyData); // Firestoreã«ä¿å­˜

    // è¿”ä¿¡ã‚’UIã«è¡¨ç¤º
    renderReplies(postId);

    // å…¥åŠ›ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’ãƒªã‚»ãƒƒãƒˆ
    input.value = "";
    updateReplyCharCount(postId);
  } catch (error) {
    console.error("è¿”ä¿¡ã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ:", error);
  }
}



async function renderReplies(postId) {
  const container = document.getElementById(`replies-${postId}`);
  container.innerHTML = "";  // æ—¢å­˜ã®å†…å®¹ã‚’ãƒªã‚»ãƒƒãƒˆ

  if (!window.db) return;

  const { collection, query, where, getDocs, orderBy } = await import("https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js");

  const q = query(collection(window.db, "replies"), where("postId", "==", postId), orderBy("time", "asc"));
  
  try {
    const querySnapshot = await getDocs(q);
    querySnapshot.forEach(doc => {
      const reply = doc.data();
      const div = document.createElement("div");
      const timeStr = formatRelativeTime(reply.time.toDate());
      div.className = "reply-item";
      const convertedReply = reply.text.replace(/\n/g, "<br>");
      div.innerHTML = `<strong>${reply.user}</strong>: ${convertedReply} <span style="font-size: 0.75em; color: #999;">${timeStr}</span>`;

      container.appendChild(div);
    });
  } catch (error) {
    console.error("è¿”ä¿¡ã®è¡¨ç¤ºã«å¤±æ•—ã—ã¾ã—ãŸ:", error);
  }
}



		function renderReplyAndLikeCount(key) {
			const likeCount = likeMap[key]?.size || 0;
			const replyCount = replyMap[key]?.length || 0;

			return `
				<div class="icon-with-count">
					<button class="icon-btn" style="background-image: url('icons/icon-like.png');" title="ã„ã„ã­" onclick="toggleLike('${key}')"></button>
					<span class="count-text" id="likeCount-${key}">${likeCount}</span>
				</div>
				<div class="icon-with-count">
					<button class="icon-btn" style="background-image: url('icons/icon-reply.png');" title="è¿”ä¿¡" onclick="toggleReplyBox('${key}')"></button>
					<span class="count-text" id="replyCount-${key}">${replyCount}</span>
				</div>
			`;
		}



	let currentTimeline = "tab1"; // åˆæœŸã¯1ç•ªã‚¿ãƒ–

function switchTimeline(type) {
  currentTimeline = type;

  document.querySelectorAll(".tab-btn").forEach(btn => btn.classList.remove("active"));
  event.target.classList.add("active");

  filterByTimeline();
}

function filterByTimeline() {
  const messages = document.querySelectorAll("#messageList li");
  messages.forEach(msg => {
    const timelineType = msg.dataset.timeline;
    if (timelineType === currentTimeline) {
      msg.style.display = "block";
    } else {
      msg.style.display = "none";
    }
  });
}

const likeMap = {};
const replyMap = {};

function toggleReplyBox(key) {
  const box = document.getElementById(`replyBox-${key}`);
  if (box) {
    box.style.display = box.style.display === "none" ? "block" : "none";
  }
}


async function toggleLike(postId) {
  const user = document.getElementById("displayNameInput")?.value.trim() || "åŒ¿å";

  if (!window.db) return;

  const { collection, doc, setDoc, getDocs, query, where } = await import("https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js");

  try {
    const likeRef = collection(window.db, "likes");
    const q = query(likeRef, where("postId", "==", postId), where("user", "==", user));

    const querySnapshot = await getDocs(q);
    if (!querySnapshot.empty) {
      alert("ã™ã§ã«ã„ã„ã­ã—ã¦ã„ã¾ã™ï¼");
      return;
    }

    // æ–°ã—ã„ã€Œã„ã„ã­ã€ã‚’Firestoreã«è¿½åŠ 
    await setDoc(doc(likeRef), {
      postId: postId,
      user: user,
      time: serverTimestamp(),
    });

    // ã„ã„ã­æ•°ã®ã‚«ã‚¦ãƒ³ãƒˆã‚’æ›´æ–°
    const likeCount = await getDocs(query(collection(window.db, "likes"), where("postId", "==", postId)));
    document.getElementById(`likeCount-${postId}`).textContent = likeCount.size;
  } catch (error) {
    console.error("ğŸ”¥ ã„ã„ã­ä¿å­˜ã‚¨ãƒ©ãƒ¼:", error);
  }
}





	function updateCharacterCount() {
  const input = document.getElementById("messageInput");
  const charCount = document.getElementById("charCount");
  const postButton = document.querySelector("#postFormWrapper button:not(.cancel-btn)");

  const length = input.value.length;
  charCount.textContent = `${length} / 300`;

  if (length > 300) {
    charCount.style.color = "red";
    postButton.disabled = true;
  } else {
    charCount.style.color = "#0a1d4d";
    postButton.disabled = false;
  }
}

	function autoLink(text) {
  const urlRegex = /(https?:\/\/[^\s]+)/g;
  return text.replace(urlRegex, url => `<a href="${url}" target="_blank" rel="noopener noreferrer">${url}</a>`);
	}

	function filterMessages() {
  const keyword = document.getElementById("searchInput").value.trim();
  const messages = document.querySelectorAll("#messageList li");

  messages.forEach(msg => {
    const textElement = msg.querySelector(".message-text");
    const originalText = textElement.dataset.original || textElement.textContent;

    // ä¿å­˜ç”¨ï¼ˆåˆå›ã®ã¿ï¼‰
    if (!textElement.dataset.original) {
      textElement.dataset.original = originalText;
    }

    if (keyword === "") {
      msg.style.display = "block";
      textElement.innerHTML = originalText;
    } else if (originalText.includes(keyword)) {
      msg.style.display = "block";

      // ğŸ”¶ ä¸€è‡´éƒ¨åˆ†ã«ãƒãƒ¼ã‚¯ã‚’ä»˜ã‘ã‚‹ãƒ‹ãƒ£ãƒ³
      const highlighted = originalText.replaceAll(keyword, `<mark>${keyword}</mark>`);
      textElement.innerHTML = highlighted;
    } else {
      msg.style.display = "none";
    }
  });
}

function toggleIconSelector() {
  const selector = document.getElementById("iconSelector");
  selector.style.display = selector.style.display === "none" ? "block" : "none";
}

function selectIcon(filename) {
  document.getElementById("profileIcon").src = filename;
  localStorage.setItem("profileIcon", filename);
  document.getElementById("iconSelector").style.display = "none";
}
function loadProfileIcon() {
  const savedIcon = localStorage.getItem("profileIcon") || "icons/p-icon-01.png";
  document.getElementById("profileIcon").src = savedIcon;
}

async function loadPostsFromFirestore() {
  if (!window.db) {
    console.error("Firestore ãŒåˆæœŸåŒ–ã•ã‚Œã¦ã„ã¾ã›ã‚“");
    return;
  }

  const { collection, onSnapshot, query, orderBy } = await import("https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js");

  const q = query(collection(window.db, "posts"), orderBy("time", "desc"));

  // ğŸ” ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã§ç›£è¦–ã—ã¦åæ˜ ï¼
  onSnapshot(q, snapshot => {
    document.getElementById("messageList").innerHTML = ""; // ä¸€åº¦å…¨ã‚¯ãƒªã‚¢
    snapshot.forEach(doc => {
      renderPostFromFirestore(doc.data(), doc.id); // â† docIdã‚’æ¸¡ã™
      renderLikeCount(doc.id);  // ã„ã„ã­æ•°ã‚‚è¡¨ç¤º
    });
  });
}




async function renderLikeCount(postId) {
  if (!window.db) return; // FirestoreãŒåˆæœŸåŒ–ã•ã‚Œã¦ã„ãªã‘ã‚Œã°çµ‚äº†

  const { collection, query, where, getDocs } = await import("https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js");

  // Firestoreã§ã€Œã„ã„ã­ã€ãƒ‡ãƒ¼ã‚¿ã‚’æ¤œç´¢
  const q = query(collection(window.db, "likes"), where("postId", "==", postId));

  // ã‚¯ã‚¨ãƒªã‚’å®Ÿè¡Œã—ã€çµæœã‚’å–å¾—
  const querySnapshot = await getDocs(q);

  // å–å¾—ã—ãŸçµæœã‹ã‚‰ã€Œã„ã„ã­ã€æ•°ã‚’åæ˜ 
  document.getElementById(`likeCount-${postId}`).textContent = querySnapshot.size;
}



document.addEventListener("DOMContentLoaded", loadProfileIcon);
document.addEventListener("DOMContentLoaded", () => {
  loadProfileIcon();
  loadPostsFromFirestore(); // â† Firestoreã®æŠ•ç¨¿èª­ã¿è¾¼ã¿ï¼
});


//* main-settingã®åˆ‡ã‚Šæ›¿ãˆ *//
function toggleMenu() {
  const setting = document.getElementById("settingScreen");
  const main = document.getElementById("mainScreen");

  if (setting.classList.contains("show")) {
    setting.classList.remove("show");
    main.style.display = "block";
    window.scrollTo(0, savedScrollY); // â†ã“ã‚Œã‚’è¿½åŠ ï¼
  } else {
    savedScrollY = window.scrollY; // â†ã“ã‚Œã‚‚è¿½åŠ ï¼
    setting.classList.add("show");
    main.style.display = "none";
  }
}

function renderPostFromFirestore(post, docId) {
  const key = `firestore-${Math.random().toString(36).substring(2, 9)}`;
  const li = document.createElement("li");
  li.dataset.timeline = post.timeline || "tab1";
  li.dataset.docId = docId; // â† Firestoreã®IDã‚’ä¿å­˜

  const savedName = localStorage.getItem("displayName") || "";
  const isOwn = (post.user === savedName);
  li.className = "message " + (isOwn ? "own" : "other");

  const formattedText = autoLink(post.text).replace(/\n/g, "<br>");
  const date = post.time?.toDate ? post.time.toDate() : new Date();

  li.innerHTML = `
    <div class="message-header">
      <span class="message-user">
        <img src="${post.icon}" class="user-icon" />
        ${post.user || "åŒ¿å"}
      </span>
      <div style="margin-left: auto; display: flex; align-items: center; gap: 8px;">
        ${renderReplyAndLikeCount(key)} <!-- ã„ã„ã­æ•°ã‚’è¡¨ç¤º -->
        <div style="position: relative;">
          <button class="menu-toggle" onclick="toggleMenu('${key}')"></button>
          <div class="menu-options" id="menu-${key}">
              <button onclick="deletePostFromFirestore('${docId}', this.closest('li'))">
								<img src="icons/icon-delete.png" style="width: 16px; height: 16px;" /> å‰Šé™¤
							</button>
          </div>
        </div>
        <span class="message-time">${formatRelativeTime(date)}</span>
      </div>
    </div>

    <div class="message-text" data-original="${post.text}">${formattedText}</div>
  `;

  document.getElementById("messageList").appendChild(li);
}





  function autoGrow(element) {
    element.style.height = "auto";
    element.style.height = (element.scrollHeight) + "px";
  }

	function setDisplayName(name) {
		localStorage.setItem("displayName", name);
	}
	function toggleDmList() {
  alert("DMæ©Ÿèƒ½ã¯ã¾ã æœªå®Ÿè£…ã§ã™ã€‚ä»Šå¾Œã“ã“ã«DMãƒªã‚¹ãƒˆã‚’è¡¨ç¤ºã—ã¾ã™ï¼");
}

  </script>


</body>
</html>
